
version: "3.9"

services:
  # =============================================================================
  # Infrastructure Services
  # =============================================================================

  mongo:
    image: mongo:6.0.26
    container_name: mongo
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    restart: unless-stopped
    networks:
      - trading_network

  redis:
    image: redis:alpine
    container_name: redis
    ports:
      - "6379:6379"
    command: ["redis-server", "--appendonly", "yes"]
    restart: unless-stopped
    networks:
      - trading_network

  # =============================================================================
  # Application Services
  # =============================================================================

  data_feed:
    build:
      context: ..
      dockerfile: services/data_feed/Dockerfile
    container_name: data_feed
    depends_on:
      - redis
      - mongo
    environment:
      - MONGO_HOST=mongo
      - REDIS_HOST=redis
    restart: unless-stopped
    networks:
      - trading_network
    profiles:
      - data_feed
      - all

  indicator_engine:
    build:
      context: ..
      dockerfile: services/indicator_engine/Dockerfile
    container_name: indicator_engine
    depends_on:
      - redis
      - mongo
    environment:
      - MONGO_HOST=mongo
      - REDIS_HOST=redis
      - PYTHONUNBUFFERED=1
    restart: unless-stopped
    networks:
      - trading_network
    profiles:
      - indicator
      - all

  strategy_engine:
    build:
      context: ..
      dockerfile: services/strategy_engine/Dockerfile
    container_name: strategy_engine
    depends_on:
      - redis
      - mongo
    environment:
      - MONGO_HOST=mongo
      - REDIS_HOST=redis
      - PYTHONUNBUFFERED=1
    restart: unless-stopped
    networks:
      - trading_network
    profiles:
      - strategy
      - all

  execution_engine:
    build:
      context: ..
      dockerfile: services/execution_engine/Dockerfile
    container_name: execution_engine
    depends_on:
      - redis
      - mongo
    environment:
      - MONGO_HOST=mongo
      - REDIS_HOST=redis
      - PYTHONUNBUFFERED=1
    restart: unless-stopped
    networks:
      - trading_network
    profiles:
      - execution
      - all

  telegram_engine:
    build:
      context: ..
      dockerfile: services/telegram_engine/Dockerfile
    container_name: telegram_engine
    depends_on:
      - redis
    env_file:
      - ../config.env
    environment:
      - REDIS_HOST=redis
      - PYTHONUNBUFFERED=1
    restart: unless-stopped
    networks:
      - trading_network
    profiles:
      - telegram
      - all

  monitoring_engine:
    build:
      context: ..
      dockerfile: services/monitoring_engine/Dockerfile
    container_name: monitoring_engine
    depends_on:
      - redis
      - mongo
    environment:
      - MONGO_HOST=mongo
      - REDIS_HOST=redis
      - PYTHONUNBUFFERED=1
    restart: unless-stopped
    networks:
      - trading_network
    profiles:
      - monitor
      - all

networks:
  trading_network:
    driver: bridge

volumes:
  mongo_data:
